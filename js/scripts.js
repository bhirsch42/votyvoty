// Generated by CoffeeScript 1.8.0
(function() {
  var clickOption, createClientOption, createServerOption, initHome, initVoty, loadVoty, newVoty, switchView;

  switchView = function(id) {
    return $('.view').velocity({
      opacity: 0
    }, {
      complete: function() {
        $('.view').addClass('hidden');
        $('#' + id).removeClass('hidden');
        return $('#' + id).velocity({
          opacity: 1
        });
      }
    });
  };

  clickOption = function($option) {
    if ($option.hasClass('selected')) {
      $.post('/option/downvote', {
        id: Voty.id,
        message: Voty.options[parseInt($option.data('index'))].message
      });
      return $option.removeClass('selected');
    } else {
      $.post('/option/upvote', {
        id: Voty.id,
        message: Voty.options[parseInt($option.data('index'))].message
      });
      return $option.addClass('selected');
    }
  };

  createClientOption = function(message) {
    var createOption, newOption, option, slabEl, _i, _len, _ref;
    if (!message) {
      return false;
    }
    _ref = Voty.options;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      option = _ref[_i];
      if (option.message.toUpperCase() === message.toUpperCase()) {
        return false;
      }
    }
    Voty.options.push({
      'message': message,
      votes: 0
    });
    slabEl = $('<span style="width: 100%; margin: 5px;"></span>').html(message);
    newOption = $('<div class="option"></div>').append(slabEl);
    $('#ballot').append(newOption);
    newOption.attr('data-index', Voty.options.length - 1);
    newOption.click(function() {
      return clickOption($(this));
    });
    slabEl.slabText();
    createOption = $('#create-option').detach();
    $('#ballot').append(createOption);
    return $('#new-option-text').focus().val('');
  };

  createServerOption = function(message) {
    return $.post('option/add', {
      id: window.Voty.id,
      message: message
    });
  };

  newVoty = function() {
    var success;
    return $.post('voty/new', success = function(data, textStatus, jqXHR) {
      var url;
      window.Voty = JSON.parse(data);
      url = document.location;
      document.location = url + window.Voty.id;
      switchView('voty');
      return initVoty();
    });
  };

  loadVoty = function(voty_id) {
    var success;
    return $.post('voty/get', {
      id: voty_id
    }, success = function(data, textStatus, jqXHR) {
      var options;
      window.Voty = JSON.parse(data);
      switchView('voty');
      initVoty();
      options = window.Voty.options;
      window.Voty.options = [];
      return $(window).delay(500).queue(function() {
        var option, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = options.length; _i < _len; _i++) {
          option = options[_i];
          _results.push(createClientOption(option.message));
        }
        return _results;
      });
    });
  };

  initVoty = function() {
    $('#create-option').on('submit', function() {
      var val;
      val = $('#new-option-text').val();
      createClientOption(val);
      createServerOption(val);
      return false;
    });
    $('#sidebar-toggle').click(function() {
      $('#sidebar').toggleClass('open');
      return $(this).toggleClass('open');
    });
    $('#results-button').click(function() {
      var $results, success;
      $('#ballot').css('display', 'none');
      $results = $('#results');
      $results.css('display', 'block');
      $results.empty();
      return $.post('voty/get', {
        id: window.Voty.id
      }, success = function(data, textStatus, jqXHR) {
        var option, _i, _len, _ref, _results;
        window.Voty = JSON.parse(data);
        _ref = window.Voty.options;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          option = _ref[_i];
          _results.push($results.append($("<div>" + option.message + ", " + option.votes + "</div>")));
        }
        return _results;
      });
    });
    return $('#ballot-button').click(function() {
      $('#ballot').css('display', '');
      return $('#results').css('display', 'none');
    });
  };

  initHome = function() {
    return $('#new-voty').click(function() {
      newVoty();
      return false;
    });
  };

  window.onload = function() {
    var voty_id;
    voty_id = document.location.pathname;
    voty_id = voty_id.substring(1, voty_id.length);
    console.log(voty_id);
    if (voty_id) {
      return loadVoty(voty_id);
    } else {
      return initHome();
    }
  };

}).call(this);
